---
sectionclass: h2
sectionid: cicd
parent-id: devops
title: Continuous Integration and Continuous Delivery
---

Your development team are making an increasing number of modifications to your application code. It is no longer feasible to manually deploy updates.

You are required to create a robust DevOps pipeline supporting CI/CD to deploy code changes. [Codefresh](https://codefresh.io/features/) is a CI/CD solution for containers and Kubernetes/Helm. You will use the Codefresh platform to setup pipelines for automatic deployments. Codefresh offers free accounts in the cloud, which are fully functional and can be connected with any Git repository and any Kubernetes cluster.

> **Hint**
> Make sure you tokenize the Docker image tags in your Kubernetes YAML configuration files instead of using `latest`. You'll need to set those in the build pipeline to the Build ID.




### Tasks

First you need to sign-up for a Codefresh account (using your git provider as an authentication mechanism)

#### Create a Codefresh account


You can create a free Codefresh account (free forever and fully functional) by signing up at [https://g.codefresh.io/signup](https://g.codefresh.io/signup). You can use any of the supported providers
shown such as Azure or Github.

![Codefresh signup](media/codefresh/codefresh-signup.png)

You will be asked to confirm the permissions requests for your GIT provider. Codefresh does not commit
anything in your GIT repositories (it only reads them to check out code) and the privileges needed are mostly
for automatic triggers (i.e. starting a pipeline when a commit happens).

You will also be asked to provide a username for your Codefresh account. Once that is done you will see the main Codefresh User Interface

![Codefresh User Interface](media/codefresh/codefresh-ui.png)


> **Hint**
> Codefresh supports multi-login accounts. You can signup/login with multiple git providers
> and if the email used is the same, you will always reach the same Codefresh account.

For more information see the [create account documentation](https://codefresh.io/docs/docs/getting-started/create-a-codefresh-account/).




#### Fork the source repositories on GitHub 

The repository of the application that you are going to use is located at [https://github.com/Azure/azch-captureorder](https://github.com/Azure/azch-captureorder).


Login into your Github account and then navigate to the repository URL. Click the *Fork* button on the top right of the
page:

![Fork git repository](media/codefresh/fork-button.png)

Github will start the forking process, so that all files are available to your account as well.

![Import repository to Azure Repos](media/codefresh/forking-process.png)

Once this is finished, you will see a "copy" of the git repository in your own account.


#### Create build pipeline for the application Docker container

As a first step for Continuous Integration you will create a pipeline that automatically builds a Docker image
for the sample application, everytime a commit happens.



Go back to your Codefresh account and select *Repositories* from the left sidebar. Click *Add new repository*

![Add new repository](media/codefresh/add-new.png)

You will see a repository browser. Make sure that your git provider is selected on the right drop-down menu. Type `az`
to filter your repositories and select the sample application.

![Select sample repository](media/codefresh/select-repository.png)

Once the repository is selected Codefresh will ask you on the build method. Select the middle option - Dockerfile.

![Select build method](media/codefresh/build-setup.png)

The sample application already contains a [Dockerfile](https://github.com/Azure/azch-captureorder/blob/master/Dockerfile). Codefresh will detect that and show you the contents for verification:

![Verify Dockerfile](media/codefresh/dockerfile-review.png)

Click *Create* to continue. The final step asks you which branch you want to use for the main build. Leave the default (master) and click *Create Pipeline*.
The Git repository is now successfully added into Codefresh. From now on you can find the project in the main Codefresh Dashboard (repositories)

Codefresh will then present you with the configuration of your pipeline. You will also see an auto-generated `codefresh.yml` pipeline
definition that just builds the docker image. The defaults are fine. Click the *Build* button and confirm your branch selection.

Wait for the pipeline to finish.

![Run Docker pipeline](media/codefresh/build-pipeline.png)


You can click on each individual step to see its logs. Once the pipeline is finished Codefresh will automatically push the Docker
image to the [private Docker registry](https://codefresh.io/docs/docs/docker-registries/codefresh-registry/) that comes built-in to all Codefresh accounts.

Click on *Images* on the left sidebar to inspect your image.

![Docker registry](media/codefresh/codefresh-docker-registry.png)


Congratulations! You now have a basic pipeline that:

1. Checks out your git repository
1. Uses the dockerfile to create a Docker image
1. Pushes the Docker image to a registry




#### Connect the Azure Container Registry in Codefresh

The built-in Docker registry that Codefresh offers in all accounts works fine on its own. However, you have already setup secrets in the cluster for the Azure Container registry so it would make sense to change the pipeline to also push images there as well.


In the Codefresh UI, select *Account Settings* on the left sidebar and then click on *Configure* next to [Docker Registry](https://g.codefresh.io/account-admin/account-conf/integration/registry).

![Codefresh Integrations](media/codefresh/integrations.png)

Click the *Add Registry* dropdown and then select *Other Registries*.

Fill in the details for the Azure Container registry registry with the following information:

* Registry name: `myazureregistry` (user defined - lowercase)
* Username: Your service principal ID
* Password: Your service principal password
* Domain: `akschallengeXXXXXXXX.azurecr.io`

Where `XXXXXXXX` is the random number assigned to your Docker registry during creation.

![Integrating Azure Registry](media/codefresh/connect-azure-registry.png)

Click the *Test* button to make sure that your credentials are correct and finally the *Save* button to apply your changes.
Codefresh is now connected to your Azure Container registry and can pull images from it.

For more information see the documentation on [external registries](https://codefresh.io/docs/docs/docker-registries/external-docker-registries/) and [custom registries](https://codefresh.io/docs/docs/docker-registries/external-docker-registries/other-registries/).


#### Modify your pipeline to push to Azure Container registry

By default all Codefresh pipelines automatically push to the internal Docker registry. To use the external Azure Registry
you need to change your pipeline and add a [dedicated push step](https://codefresh.io/docs/docs/codefresh-yaml/steps/push-1/).


Go back to your repositories by clicking *Repositories* on the left sidebar. Locate your project and click the "gear" icon in order to edit the pipeline.

![Edit pipeline](media/codefresh/edit-pipeline.png)

In the *Workflow* section make sure that the first option is selected - *Inline YAML* and paste the following [codefresh.yml](yaml-solutions/devops/codefresh/build-and-push.yml) into the editor (removing its previous contents):

```yaml
{% raw %}
version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: captureorder
    working_directory: ./
    dockerfile: Dockerfile
  PushingDockerImage:
    title: Pushing Docker Image to Azure
    type: push
    candidate: '${{BuildingDockerImage}}'
    tag: ${{CF_SHORT_REVISION}}
    registry: myazureregistry
{% endraw %} 
```

Run the pipeline and this time Codefresh will also push the image to the Azure Docker registry.

![Push pipeline](media/codefresh/push-pipeline.png)

You can see the tag of the image in the Azure Container Registry UI

![View Docker Image](media/codefresh/view-image.png)

You now have a pipeline that pushes in both the internal registry of Codefresh as well as the external Azure registry.


#### Connect your Azure cluster to Codefresh

With the basic pipeline in place, you will [now connect your Kubernetes](https://codefresh.io/docs/docs/deploy-to-kubernetes/add-kubernetes-cluster/#adding-aks-cluster) cluster in Codefresh. This way
you will extend the pipeline with deployment capabilities in the next section.


Go to your account integrations by selecting *Account Settings* on the left sidebar and then clicking on *Configure* next to "Kubernetes".

![Cluster integrations](media/codefresh/cluster-integrations.png)

From the cluster screen, select "Azure AKS" from the drop-down and authenticate with your Azure account. You will get a new dialog with your subscription and cluster selection:

![Add Azure cluster](media/codefresh/select-cluster.png)

> **Hint**
> You can also add your Azure cluster as a [custom cluster](https://codefresh.io/docs/docs/deploy-to-kubernetes/add-kubernetes-cluster/#adding-any-other-cluster-type-not-dependent-on-any-provider) by selecting *Azure Custom*.

Once the integration is complete, Codefresh will scan the cluster to finds its nodes. To verify the connection
go back to the main Codefresh screen (click on the left arrow on the top left of the screen) and then select *Kubernetes*
from the left sidebar. 

You will see a view of all your namespaces in the cluster.

![View Azure K8s cluster](media/codefresh/view-cluster.png) 


Codefresh is now connected to your cluster. 

> **Hint**
> Make sure to note down the name your cluster as it appears in the dashboard, as you will use it later on in the deployment
pipeline.



#### Create a continuous deployment pipeline

As a final step you will create a Continuous deployment pipeline that automatically deploys the application to your Kubernetes cluster.


Commit into your git repository the following files:

- [captureorder-deployment.yaml](yaml-solutions/devops/captureorder-deployment.yaml)
- [captureorder-service.yaml](yaml-solutions/devops/captureorder-service.yaml)
- [captureorder-hpa.yaml](yaml-solutions/devops/captureorder-hpa.yaml)

> **Hints**
> - One thing you'll notice is that, in `captureorder-deployment.yaml`, **you'll need to change the image name** `<unique-acr-name>.azurecr.io/captureorder:##BUILD_ID##`. Put in your Azure Container Registry name.
> - Also notice the `##BUILD_ID##`. This is a placeholder that will get replaced further down the line by the release pipeline by the actual version being deployed.

These files define the deployment for your application. You can place them in the root of the git repository or any other folder of your choice (e.g. `deploy-yaml`, `k8s-files`)

Once the files are committed you can now use a [custom kubectl step](https://codefresh.io/docs/docs/deploy-to-kubernetes/custom-kubectl-commands/) in your pipeline to deploy them. We also need
an [extra freestyle step](https://codefresh.io/docs/docs/codefresh-yaml/steps/freestyle/) to perform the replacement of the image.
Here is the final [codefresh.yml](yaml-solutions/devops/codefresh/build-push-deploy.yml). Make sure to replace the name of your cluster in the first `kubectl` command as it appears on your [Kubernetes dashboard](https://codefresh.io/docs/docs/deploy-to-kubernetes/manage-kubernetes/). Use quotes like `kubectl config use-context "my cluster name"`.


```yaml
{% raw %}
version: '1.0'
stages:
- build
- deploy
steps:
  BuildingDockerImage:
    title: Building Docker Image
    stage: build
    type: build
    image_name: captureorder
    working_directory: ./
    dockerfile: Dockerfile
  PushingDockerImage:
    title: Pushing Docker Image to Azure
    stage: build
    type: push
    candidate: '${{BuildingDockerImage}}'
    tag: ${{CF_SHORT_REVISION}}
    registry: myazureregistry
  ReplaceDockerImage:
    title: Setting correct docker image
    stage: deploy
    image: alpine
    commands:
     - sed -i "s/##BUILD_ID##/${CF_SHORT_REVISION}/g" captureorder-deployment.yaml
  MyCustomKubectlCommands:
    title: Running Kubectl
    image: codefresh/kubectl
    stage: deploy
    commands: 
      - kubectl config use-context <your-cluster-name-in-codefresh>
      - kubectl apply -f  captureorder-deployment.yaml  
      - kubectl apply -f  captureorder-hpa.yaml 
      - kubectl apply -f  captureorder-service.yaml
    
{% endraw %} 
```

Since there are multiple steps, this pipelines is also using [stages](https://codefresh.io/docs/docs/codefresh-yaml/stages/) for a better visual representation.




#### Verify everything works


1. Make a change to the application source code, commit the change and watch the pipelines build and release the new version.

1. Make a change to the configuration (for example, change the number of replicas), commit the change and watch the pipelines update your configuration.

![CI/CD release in progress](media/codefresh/deployment-pipeline.png)

```sh
kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
captureorder-64b49756b6-8df8p      1/1     Running   0          55s
captureorder-64b49756b6-fjk9d      1/1     Running   0          56s
captureorder-64b49756b6-rrhck      1/1     Running   0          59s
captureorder-64b49756b6-vscn7      1/1     Running   0          1m
```


> **Resources**
> - [Codefresh Registry](https://codefresh.io/docs/docs/docker-registries/codefresh-registry/)
> - [Connecting an external Registry](https://codefresh.io/docs/docs/docker-registries/external-docker-registries/)
> - [Connecting your Kubernetes cluster](https://codefresh.io/docs/docs/deploy-to-kubernetes/add-kubernetes-cluster/)
> - [Managing your cluster](https://codefresh.io/docs/docs/deploy-to-kubernetes/manage-kubernetes/)
> - [Codefresh pipelines](https://codefresh.io/docs/docs/configure-ci-cd-pipeline/introduction-to-codefresh-pipelines/)
> - [Creating pipelines](https://codefresh.io/docs/docs/configure-ci-cd-pipeline/pipelines/)
> - [Codefresh Pipeline YAML](https://codefresh.io/docs/docs/codefresh-yaml/what-is-the-codefresh-yaml/)
> - [Pipeline Steps](https://codefresh.io/docs/docs/codefresh-yaml/steps/)
> - [Custom Kubectl commands](https://codefresh.io/docs/docs/deploy-to-kubernetes/custom-kubectl-commands/)
